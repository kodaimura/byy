{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
	<div class="wrapper">
	<h2>管理者用</h2>
	<div class="form-wrapper">
	
	<form name="passwordForm" onsubmit="return false" class="mx-3 px-4 py-3 mb-3 bg-light card">
    <div id="password-error" class="text-danger"></div>
      <label for="password" class="form-label">パスワード</label>
      <div class="row">
        <div class="col-8">
          <input type="hidden" value="{{password}}" id="password-bk">
          <input type="text" class="form-control" name="password" value="{{password}}"
          oninput="onInput('password')" id="password">
        </div>
        <div class="col-4">
          <input type="button" class="btn btn-primary" value="更新" id="password-send" disabled>
        </div>
      </div>
	</form>
  <form name="taxForm" onsubmit="return false" class="mx-3 px-4 py-3 mb-3 bg-light card">
    <div id="tax-error" class="text-danger"></div>
      <label for="tax" class="form-label">消費税 (%)</label>
      <div class="row">
        <div class="col-8">
          <input type="hidden" value="{{tax}}" id="tax-bk">
          <input type="number" class="form-control" name="tax" value="{{tax}}"
          oninput="onInput('tax')" id="tax">
        </div>
        <div class="col-4">
          <input type="button" class="btn btn-primary" value="更新" id="tax-send" disabled>
        </div>
      </div>
  </form>

    <div class="mx-3 px-4 py-3 mb-3 bg-light card">
      <label for="categories" class="form-label">カテゴリー</label>
      {% for c in categories %}
      <form method="POST" action="categories/{{c.id}}">
        <div class="row">
          <div class="col-8 mb-1">
            <input type="hidden" value="{{c.category_name}}" id="category-{{c.id}}-bk">
            <input type="text" class="form-control" name="category_name" value="{{c.category_name}}" 
            oninput="onInput('category-{{c.id}}')" id="category-{{c.id}}">
          </div>
          <div class="col-4">
            <input type="submit" class="btn btn-primary" value="更新" id="category-{{c.id}}-send" disabled>
          </div>
        </div>
      </form>
      {% endfor %}
    </div>
  </div>
  </div>

  <script type="text/javascript">
    document.getElementById('password-send').addEventListener('click', () => {
      const password = document.forms.passwordForm.password.value;

      if (password.trim() === "") {
        document.getElementById('password-error').innerHTML = "新しいパスワードを入力してください";
      } else {
        fetch('password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({password})
        }).then(response => {
          if (response.ok) {
            document.getElementById('password-send').disabled = true;
            document.getElementById('password-bk').value = password;
            window.alert('パスワードを変更しました。');
          } else {
            document.getElementById('password-error').innerHTML = "更新失敗";
          }
        });
      }
    })

    document.getElementById('tax-send').addEventListener('click', () => {
      const tax = document.forms.taxForm.tax.value;

      fetch('tax', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tax})
      }).then(response => {
        if (response.ok) {
          document.getElementById('tax-send').disabled = true;
          document.getElementById('tax-bk').value = tax;
          window.alert('消費税を変更しました。');
        } else {
          document.getElementById('tax-error').innerHTML = "更新失敗";
        }
      });
    })

    const onInput = (id) => {
      const bk = document.getElementById(`${id}-bk`).value;
      const input = document.getElementById(id).value;

      document.getElementById(`${id}-send`).disabled = (bk == input)? true : false;
    }

  </script>
{% endblock %}