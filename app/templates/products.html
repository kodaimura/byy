<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>商品ページ</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">
	<nav class="navbar navbar-light" style="background-color:#00db95;">
		<span class="navbar-brand px-3">
			<img src="/static/img/baka_logo.png" alt="バカ安八百屋" width="150" height="auto">
		</spa>
	</nav>
	<div class="container">
	<!-- おすすめ商品カルーセル -->
	<div id="recommendCarousel" class="carousel slide mb-5 carousel-dark" data-bs-ride="carousel">
  	<div class="carousel-inner">
  		{% for p in recommends %}
  			{% if loop.index == 1 %}
				<div class="carousel-item active">
				{% else %}
				<div class="carousel-item">
  			{% endif %}
					<div class="card w-60 mx-auto">
						<img src="/static/img/tmp/{{p.img_name}}" class="rounded">
						<div class="card-img-overlay">
							{% if p.stock_flg == '0' %}
							<span class="fs-4 fw-bold text-danger bg-warning badge position-absolute top-0">品切れ<span>
							{% endif %}
						</div>
						<div class="card-body position-relative pb-5">
							<div class="card-title fw-bold lh-1 fs-5">
								{{p.product_name}}<span class="small">({{p.production_area}}産)</span>
							</div>
							<div class="text-end fw-bolder fs-2 text-danger lh-1">
								<small class="text-muted fs-5"> {{p.quantity}} </small>
								<span>¥{{p.price}}</span>
								<span>(¥{{(p.price * 1.1)|int}})</span>
							</div>
							<hr class="text-success my-2">
    					<div class="card-text lh-1" style="font-size:0.8rem">{{p.comment}}</div>
    					<hr class="text-success my-2">
    					<div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
    						<button class="btn btn-warning rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="modal" data-bs-target="#addCartModal" style="z-index:1;font-size:0.7rem" onclick="setupModal({{p}})">
    							&nbsp;<span class="material-icons">add_shopping_cart</span>&nbsp;カートに追加&nbsp;&nbsp;
    						</button>
    					</div>
  					</div>
					</div>
				</div>
			{% endfor %}
  	</div>
  	<button class="carousel-control-prev" type="button" data-bs-target="#recommendCarousel" data-bs-slide="prev">
  	  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
  	  <span class="visually-hidden">Previous</span>
  	</button>
  	<button class="carousel-control-next" type="button" data-bs-target="#recommendCarousel" data-bs-slide="next">
  	  <span class="carousel-control-next-icon" aria-hidden="true"></span>
  	  <span class="visually-hidden">Next</span>
  	</button>
	</div>
	<!-- おすすめ商品カルーセル -->

	<!-- カテゴリータブ -->
	<div class="nav category-tabs mb-3">
		{% for c in categories %}
			{% if loop.index == 1 %}
			<a href="#{{c.id}}" class="nav-item category-tab active" data-bs-toggle="tab">{{c.category_name}}</a>
			{% else %}
    	<a href="#{{c.id}}" class="nav-item category-tab" data-bs-toggle="tab">{{c.category_name}}</a>
    	{% endif %}
   	{% endfor %}
	</div>
	<!-- カテゴリータブ -->

	<!-- 商品一覧 -->
	<div class="tab-content mb-4">
	{% for c in categories %}
		{% if loop.index == 1 %}
		<div id="{{c.id}}" class="tab-pane active show">
		{% else %}
		<div id="{{c.id}}" class="tab-pane">
  	{% endif %}
			<div class="row">
    	{% for p in products %}
    		{% if p.category_id == c.id %}
				<div class="card col-6">
					<img src="/static/img/tmp/{{p.img_name}}" class="rounded">
					<div class="card-img-overlay">
						{% if p.stock_flg == '0' %}
						<span class="fs-4 fw-bold text-danger bg-warning badge position-absolute top-0">品切れ</span>
						{% endif %}
						{% if p.recommend_flg == '1' %}
						<span class="fs-5 fw-bold text-light bg-danger badge position-absolute top-0 end-0"><i>おすすめ</i></span>
						{% endif %}
					</div>
					<div class="card-body position-relative pb-5">
						<div class="card-title fw-bold lh-1">
							{{p.product_name}}<span class="small">({{p.production_area}}産)</span>
						</div>
						<div class="text-end fw-bolder fs-4 text-danger lh-1">
							<small class="text-muted fs-6"> {{p.quantity}} </small>
							<span>¥{{p.price}}</span>
							<span>(¥{{(p.price * 1.1)|int}})</span>
						</div>
						<hr class="text-success my-2">
    				<div class="card-text lh-1" style="font-size:0.8rem">{{p.comment}}</div>
    				<hr class="text-success my-2">
    				<div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
    					<button class="btn btn-warning rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="modal" data-bs-target="#addCartModal" style="z-index:1;font-size:0.7rem" onclick="setupModal({{p}})">
    						&nbsp;<span class="material-icons">add_shopping_cart</span>&nbsp;カートに追加&nbsp;&nbsp;
    					</button>
    				</div>
  				</div>
				</div>
				{% endif %}
  		{% endfor %}
  		</div>
  	</div>
  {% endfor %}
  </div>
  <!-- 商品一覧 -->

	<!-- カート追加モーダル -->
	<div class="modal fade" id="addCartModal">
  	<div class="modal-dialog">
    	<div class="modal-content">
      	<div class="modal-header">
        	<h5 class="modal-title">個数入力</h5>
        	<button type="button" class="btn-close" id="modalClose" data-bs-dismiss="modal" aria-label="Close"></button>
      	</div>
      	<input type="hidden" id="modalProductId">
      	<div class="modal-body position-relative">
      		<div id="modalImg"></div>
					<div>
						<div class="fw-bold fs-3">
							<span id="modalProductName"></span>
							<span class="small" id="modalProductionArea"></span>
						</div>
						<div class="text-end fw-bolder fs-3 text-danger">
							<small class="text-muted fs-5" id="modalQuantity"></small>
							<span id="modalPrice"></span>
							<span id="modalTaxPrice"></span>
						</div>
    				<div class="modal-footer">
    					<button onclick="countDown()" style="font-size:0.7rem">
    						<span class="material-icons">remove</span>
    					</button>
    					<input type="number" id="orderQuantity" min="0" max="99" value="0">個
    					<button onclick="countUp()" style="font-size:0.7rem">
    						<span class="material-icons">add</span>
    					</button>
    					<button class="btn btn-warning rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="	modal" data-bs-target="#addCartModal" style="z-index:1;" onclick="addToCart()">
    						&nbsp;<span class="material-icons">add_shopping_cart</span>&nbsp;カートに追加&nbsp;&nbsp;
    					</button>
    				</div>
  				</div>
  				<div id="modalMessage" class="position-absolute top-50 start-50 translate-middle">
  				</div>
      	</div>
    	</div>
  	</div>
	</div>
	<!-- カート追加モーダル -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
  <script type="text/javascript">
  	const countDown = () => {
  		let input = document.getElementById("orderQuantity")
  		input.value = (isNaN(input.value) || input.value == "" || input.value == "0")? 
  		0 : parseInt(input.value) - 1
  	}

  	const countUp = () => {
  		let input = document.getElementById("orderQuantity")
  		input.value = (isNaN(input.value) || input.value == "")? 1 : parseInt(input.value) + 1
  	}

  	const setupModal = (product) => {
  		document.getElementById("orderQuantity").value = 0
  		document.getElementById("modalProductId").value = product.id
  		document.getElementById("modalImg").innerHTML = `<img src="/static/img/tmp/${product.img_name}" class="rounded mx-auto d-block">`
  		document.getElementById("modalProductName").innerHTML = product.product_name
  		document.getElementById("modalProductionArea").innerHTML = `(${product.production_area}産)`
  		document.getElementById("modalQuantity").innerHTML = product.quantity
  		document.getElementById("modalPrice").innerHTML = `¥${product.price}`
  		document.getElementById("modalTaxPrice").innerHTML = `(¥${Math.round(product.price * 1.1)})`
  	}

  	const addToCart = () => {
  		const id = document.getElementById("modalProductId").value
  		const name = document.getElementById("modalProductName").innerHTML
  		const area = document.getElementById("modalProductionArea").innerHTML
  		const price = document.getElementById("modalPrice").innerHTML
  		const oq = document.getElementById("orderQuantity").value

  		const order = {
  			"id": id,
  			"product_name": name,
  			"production_area": area,
  			"price": price,
  			"order_quantity": oq
  		}

  		let orders = JSON.parse(localStorage.getItem('order'))
  		orders.push(order)

  		if (oq > 0) {
  			localStorage.setItem('order', JSON.stringify(orders))
  			document.getElementById("modalMessage").innerHTML = 
  			`<div class="alert alert-info">カートに追加しました<div>`
  			setTimeout(() => {
  				document.getElementById("modalClose").click()
  				document.getElementById("modalMessage").innerHTML = ""
  			}, 2500)
  		} else {
  			document.getElementById("modalMessage").innerHTML = 
  			`<div class="alert alert-danger">個数を入力してください<div>`
  			setTimeout(() => {
  				document.getElementById("modalMessage").innerHTML = ""
  			}, 6000)
  		}
  	}

    window.addEventListener('DOMContentLoaded', (event) => {
    	localStorage.setItem('order', "[]")
    	const positionY = localStorage.getItem('positionY');
    	if (positionY !== null) {
        scrollTo(0, positionY);
        localStorage.removeItem('positionY');
    	}
		});
  </script>
</body>
</html>