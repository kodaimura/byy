<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>商品ページ</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">
	<nav class="navbar navbar-light fixed-top" style="background-color:#00db95;">
		<span class="navbar-brand px-3">
			<img src="/static/img/baka_logo.png" alt="バカ安八百屋" width="150" height="auto">
		</spa>
	</nav>
	<div style="width:100%;height:70px"></div>

	<div class="container">
	<!-- おすすめ商品カルーセル -->
	<div id="recommendCarousel" class="carousel slide mb-5 carousel-dark" data-bs-ride="carousel">
  	<div class="carousel-inner">
  		{% for p in recommends %}
  			{% if loop.index == 1 %}
				<div class="carousel-item active">
				{% else %}
				<div class="carousel-item">
  			{% endif %}
					<div class="card w-60 mx-auto">
						<img src="/static/img/tmp/{{p.img_name}}" class="rounded">
						<div class="card-img-overlay">
							{% if p.stock_flg == '0' %}
							<span class="fs-4 fw-bold text-danger bg-warning badge position-absolute top-0">品切れ<span>
							{% endif %}
						</div>
						<div class="card-body position-relative pb-5">
							<div class="card-title fw-bold lh-1 fs-5">
								{{p.product_name}}<span class="small">({{p.production_area}}産)</span>
							</div>
							<div class="text-end fw-bolder fs-2 text-danger lh-1">
								<small class="text-muted fs-5"> {{p.quantity}} </small>
								<span>¥{{p.price}}</span>
								<span>(¥{{(p.price * 1.1)|int}})</span>
							</div>
							<hr class="text-success my-2">
    					<div class="card-text lh-1" style="font-size:0.8rem">{{p.comment}}</div>
    					<hr class="text-success my-2">
    					<div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
    						<button class="btn btn-warning rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="modal" data-bs-target="#modal" style="z-index:1;font-size:0.7rem" onclick="setupModal({{p}})">
    							&nbsp;<span class="material-icons">add_shopping_cart</span>&nbsp;カートに追加&nbsp;&nbsp;
    						</button>
    					</div>
  					</div>
					</div>
				</div>
			{% endfor %}
  	</div>
  	<button class="carousel-control-prev" type="button" data-bs-target="#recommendCarousel" data-bs-slide="prev">
  	  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
  	  <span class="visually-hidden">Previous</span>
  	</button>
  	<button class="carousel-control-next" type="button" data-bs-target="#recommendCarousel" data-bs-slide="next">
  	  <span class="carousel-control-next-icon" aria-hidden="true"></span>
  	  <span class="visually-hidden">Next</span>
  	</button>
	</div>
	<!-- おすすめ商品カルーセル -->

	<!-- カテゴリータブ -->
	<div class="nav category-tabs mb-3">
		{% for c in categories %}
			{% if loop.index == 1 %}
			<a href="#{{c.id}}" class="nav-item category-tab active" data-bs-toggle="tab">{{c.category_name}}</a>
			{% else %}
    	<a href="#{{c.id}}" class="nav-item category-tab" data-bs-toggle="tab">{{c.category_name}}</a>
    	{% endif %}
   	{% endfor %}
	</div>
	<!-- カテゴリータブ -->

	<!-- 商品一覧 -->
	<div class="tab-content mb-4">
	{% for c in categories %}
		{% if loop.index == 1 %}
		<div id="{{c.id}}" class="tab-pane active show">
		{% else %}
		<div id="{{c.id}}" class="tab-pane">
  	{% endif %}
			<div class="row">
    	{% for p in products %}
    		{% if p.category_id == c.id %}
				<div class="card col-6">
					<img src="/static/img/tmp/{{p.img_name}}" class="rounded">
					<div class="card-img-overlay">
						{% if p.stock_flg == '0' %}
						<span class="fs-4 fw-bold text-danger bg-warning badge position-absolute top-0">品切れ</span>
						{% endif %}
						{% if p.recommend_flg == '1' %}
						<span class="fs-5 fw-bold text-light bg-danger badge position-absolute top-0 end-0"><i>おすすめ</i></span>
						{% endif %}
					</div>
					<div class="card-body position-relative pb-5">
						<div class="card-title fw-bold lh-1">
							{{p.product_name}}<span class="small">({{p.production_area}}産)</span>
						</div>
						<div class="text-end fw-bolder fs-4 text-danger lh-1">
							<small class="text-muted fs-6"> {{p.quantity}} </small>
							<span>¥{{p.price}}</span>
							<span>(¥{{(p.price * 1.1)|int}})</span>
						</div>
						<hr class="text-success my-2">
    				<div class="card-text lh-1" style="font-size:0.8rem">{{p.comment}}</div>
    				<hr class="text-success my-2">
    				<div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
    					<button class="btn btn-warning rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="modal" data-bs-target="#modal" style="z-index:1;font-size:0.7rem" onclick="setupModal({{p}})">
    						&nbsp;<span class="material-icons">add_shopping_cart</span>&nbsp;カートに追加&nbsp;&nbsp;
    					</button>
    				</div>
  				</div>
				</div>
				{% endif %}
  		{% endfor %}
  		</div>
  	</div>
  {% endfor %}
  </div>
  <!-- 商品一覧 -->

	<!-- カート追加モーダル -->
	<div class="modal fade" id="modal">
  	<div class="modal-dialog">
    	<div class="modal-content">
      	<div class="modal-header">
        	<h5 class="modal-title">個数入力</h5>
        	<button type="button" class="btn-close" id="modalClose" data-bs-dismiss="modal" aria-label="Close"></button>
      	</div>
      	<input type="hidden" id="modalProductId">
      	<div class="modal-body">
      		<div id="modalImg"></div>
					<div>
						<div class="fw-bold fs-3">
							<span id="modalProductName"></span>
							(<span class="small" id="modalProductionArea"></span>)
						</div>
						<div class="text-end fw-bolder fs-3 text-danger">
							<small class="text-muted fs-5" id="modalQuantity"></small>
							¥<span id="modalPrice"></span> (¥<span id="modalTaxPrice"></span>)
						</div>
					</div>
				</div>
    		<div class="modal-footer">
    			<button onclick="countDown('orderQuantity')">
    				<span class="material-icons">remove</span>
    			</button>
    			<input type="number" id="orderQuantity" min="0" max="99" value="0">
    			<button onclick="countUp('orderQuantity')">
    				<span class="material-icons">add</span>
    			</button>個
    			<button class="btn btn-warning rounded-pill btn-sm text-nowrap text-white" style="z-index:1;" onclick="addToCart()">
    				&nbsp;<span class="material-icons">add_shopping_cart</span>&nbsp;カートに追加&nbsp;&nbsp;
    			</button>
  			</div>
  			<div id="modalMessage" class="position-absolute top-50 start-50 translate-middle">
  			</div>
    	</div>
  	</div>
	</div>
	<!-- カート追加モーダル -->

	<!-- 注文確認モーダル -->
	<div class="modal fade" id="modal2">
  	<div class="modal-dialog">
    	<div class="modal-content">
      	<div class="modal-header">
        	<h5 class="modal-title">注文確認</h5>
        	<button type="button" class="btn-close" id="modal2Close" data-bs-dismiss="modal" aria-label="Close"></button>
      	</div>
      	<div class="modal-body" id="modal2Body">
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="modal" data-bs-target="#modal4" style="z-index:1;" onclick="setupModal4()">
						&nbsp;&nbsp;変更&nbsp;&nbsp;
					</button>
					<button class="btn btn-info rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="modal" data-bs-target="#modal3" style="z-index:1;" onclick="setupModal3()">
						&nbsp;&nbsp;支払・受取設定へ&nbsp;&nbsp;
					</button>
  			</div>
    	</div>
  	</div>
	</div>
	<!-- 注文確認モーダル -->

	<!-- 支払・受取設定モーダル -->
	<div class="modal fade" id="modal3">
  	<div class="modal-dialog">
    	<div class="modal-content">
      	<div class="modal-header">
        	<h5 class="modal-title">支払・受取設定</h5>
        	<button type="button" class="btn-close" id="modal3Close" data-bs-dismiss="modal" aria-label="Close"></button>
      	</div>
      	<form method="POST" onsubmit="return false" name="modal3Form">
      		<div class="modal-body">
      			<div class="mb-1">
   						<label for="receive_time">時間</label>
   						<select name="receive_time" class="form-select">
   							<option value="10:00 〜 11:00" label="10:00 〜 11:00"></option>
   							<option value="11:00 〜 12:00" label="11:00 〜 12:00"></option>
   							<option value="12:00 〜 13:00" label="12:00 〜 13:00"></option>
   							<option value="13:00 〜 14:00" label="13:00 〜 14:00"></option>
   							<option value="14:00 〜 15:00" label="14:00 〜 15:00"></option>
   							<option value="15:00 〜 16:00" label="15:00 〜 16:00"></option>
   							<option value="16:00 〜 17:00" label="16:00 〜 17:00"></option>
   							<option value="17:00 〜 18:00" label="17:00 〜 18:00"></option>
   							<option value="18:00 〜 19:00" label="18:00 〜 19:00"></option>
   						</select>
   					</div>
      			<div class="mb-1">
   						<label for="how_to_pay">支払方法</label>
   						<select name="how_to_pay" class="form-select">
   							<option value="現金" label="現金"></option>
   							<option value="PayPay" label="PayPay"></option>
   						</select>
   					</div>
   					<div class="mb-1">
   						<label for="how_to_receive">受取方法</label>
   						<select name="how_to_receive" class="form-select">
   							<option value="ドライブスルー" label="ドライブスルー"></option>
   							<option value="配達" label="配達"></option>
   						</select>
   					</div>
   					<div class="mb-1">
   						<label for="address">住所 <span class="text-danger small">※配達のお客様のみ</span></label>
   						<input type="text" name="address" class="form-control">
   					</div>
					</div>
					<div class="modal-footer">
						<button class="btn btn-primary rounded-pill btn-sm text-nowrap text-white" style="z-index:1;" onclick="finalizeOrder()">
							&nbsp;&nbsp;注文確定&nbsp;&nbsp;
						</button>
  				</div>
  			</form>
  			<div id="modal3Message" class="position-absolute top-50 start-50 translate-middle">
  			</div>
    	</div>
  	</div>
	</div>
	<!-- 支払・受取設定モーダル -->

	<!-- 注文変更モーダル -->
	<div class="modal fade" id="modal4">
  	<div class="modal-dialog">
    	<div class="modal-content">
      	<div class="modal-header">
        	<h5 class="modal-title">注文変更</h5>
        	<button type="button" class="btn-close" id="modal4Close" data-bs-dismiss="modal" aria-label="Close"></button>
      	</div>
      	<div class="modal-body" id="modal4Body">
				</div>
				<div class="modal-footer">
					<button class="btn btn-success rounded-pill btn-sm text-nowrap text-white" data-bs-toggle="modal" data-bs-target="#modal2" style="z-index:1;" onclick="cartUpdateAndSetUpModal2()">
						&nbsp;&nbsp;保存&nbsp;&nbsp;
					</button>
  			</div>
    	</div>
  	</div>
	</div>
	<!-- 注文変更モーダル -->


	</div>

	<div>
		<img src="/static/img/baka_footer.png" style="width:100%;height:auto">
	</div>
	<div class="fixed-bottom" data-bs-toggle="modal" data-bs-target="#modal2" onclick="setupModal2()">
		<img src="/static/img/baka_cart.png" style="width:100%;height:auto">
	</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/static/js/liff.js"></script>
  <script type="text/javascript">
  	const countDown = (id) => {
  		let input = document.getElementById(id)
  		input.value = (isNaN(input.value) || input.value == "" || input.value == "0")? 
  		0 : parseInt(input.value) - 1
  	}

  	const countUp = (id) => {
  		let input = document.getElementById(id)
  		input.value = (isNaN(input.value) || input.value == "")? 1 : parseInt(input.value) + 1
  	}

  	const setupModal = (product) => {
  		document.getElementById("orderQuantity").value = 0
  		document.getElementById("modalProductId").value = product.id
  		document.getElementById("modalImg").innerHTML = `<img src="/static/img/tmp/${product.img_name}" class="rounded mx-auto d-block">`
  		document.getElementById("modalProductName").innerHTML = product.product_name
  		document.getElementById("modalProductionArea").innerHTML = `${product.production_area}産`
  		document.getElementById("modalQuantity").innerHTML = product.quantity
  		document.getElementById("modalPrice").innerHTML = `${product.price}`
  		document.getElementById("modalTaxPrice").innerHTML = `${Math.round(product.price * 1.1)}`
  	}

  	const addToCart = () => {
  		const id = document.getElementById("modalProductId").value
  		const name = document.getElementById("modalProductName").innerHTML
  		const area = document.getElementById("modalProductionArea").innerHTML
  		const price = document.getElementById("modalPrice").innerHTML
  		const oq = parseInt(document.getElementById("orderQuantity").value)

  		const orders0 = JSON.parse(localStorage.getItem('order'))
  		let orders = []

  		let order = {
  			"id": id,
  			"product_name": name,
  			"production_area": area,
  			"price": price,
  			"order_quantity": oq
  		}

  		for (let o of orders0) {
  			if (o.id == id) {
  				order.order_quantity += o.order_quantity
  			} else {
  				orders.push(o)
  			}
  		}
  		
  		orders.push(order)

  		if (oq > 0) {
  			localStorage.setItem('order', JSON.stringify(orders))
  			document.getElementById("modalMessage").innerHTML = 
  			`<div class="alert alert-info">カートに追加しました<div>`
  			setTimeout(() => {
  				document.getElementById("modalClose").click()
  				document.getElementById("modalMessage").innerHTML = ""
  			}, 700)
  		} else {
  			document.getElementById("modalMessage").innerHTML = 
  			`<div class="alert alert-danger">個数を入力してください<div>`
  			setTimeout(() => {
  				document.getElementById("modalMessage").innerHTML = ""
  			}, 2000)
  		}
  	}

  	const setupModal2 = () => {
  		const orders = JSON.parse(localStorage.getItem('order'))

  		let contents = 
  		`<table class="table">
  			<thead>
  				<tr><th>商品</th><th>個数</th><th>価格(税込)</th><th>小計</th></tr>
  			</thead>
  			<tbody>`

  		let priceSum = 0
  		for (const order of orders) {
  			priceSum += (parseInt(order.price) * parseInt(order.order_quantity))
  			contents += 
  			`<tr>
  				<td>${order.product_name} (${order.production_area})</td>
  				<td>${order.order_quantity}</td>
  				<td>¥${Math.round(order.price * 1.1)}</td>
  				<td>¥${Math.round(order.price * 1.1) * order.order_quantity}</td>
  			</tr>`
   		}

   		contents += 
   		`	</tbody>
   			<tfooter>
   				<tr>
   					<td>合計(税込)</td></td><td><td></td><td class="text-danger">¥${Math.round(priceSum * 1.1)}</td>
   				</tr>
   			</tfooter>
   		<table>`

   		document.getElementById("modal2Body").innerHTML = contents
  	}

  	const finalizeOrder = () => {
  		const form = document.forms.modal3Form;
  		if (form.how_to_receive.value == "配達" && form.address.value.trim() == "") {
  			document.getElementById("modal3Message").innerHTML = 
  			`<div class="alert alert-danger">配達の場合は住所を入力してください<div>`;
  			form.address.focus();
  			setTimeout(() => {
  				document.getElementById("modal3Message").innerHTML = ""
  			}, 3000)

  		} else {
  			localStorage.setItem("how_to_pay", form.how_to_pay.value)
  			localStorage.setItem("how_to_receive", form.how_to_receive.value)
  			localStorage.setItem("address", form.address.value.trim())
  			const idToken = localStorage.getItem('liffIdToken')
  			
  			//fetch()
  		}
  	}

  	const setupModal3 = () => {
  		const form = document.forms.modal3Form;

  		form.how_to_pay.value = (localStorage.getItem("how_to_pay") == "PayPay")? "PayPay" : "現金";
  		if (localStorage.getItem("how_to_receive") == "配達") {
  			form.how_to_receive.value = "配達"
  			form.address.value = localStorage.getItem("address")
  		} else {
  			form.how_to_receive.value = "ドライブスルー"
  			form.address.value = ""
  		}
  	}

  	const setupModal4 = () => {
  		const orders = JSON.parse(localStorage.getItem('order'))

  		let contents = 
  		`<table class="table">
  			<thead>
  				<tr><th></th><th>商品</th><th>個数</th><th></th><th></th><th></th></tr>
  			</thead>
  			<tbody id="modal4TBody">`

  		let priceSum = 0
  		for (let i = 0; i < orders.length; i++) {
  			priceSum += parseInt(orders[i].price)
  			contents += 
  			`<tr>
  				<td><input type="hidden" value="${orders[i].id}"></td>
  				<td>${orders[i].product_name} (${orders[i].production_area})</td>
  				<td>
  				<button onclick="countDown('oq${i}')">
    				<span class="material-icons">remove</span>
    			</button>
    			<input type="number" id="oq${i}" min="0" max="99" value="${orders[i].order_quantity}">
    			<button onclick="countUp('oq${i}')">
    				<span class="material-icons">add</span>
    			</button>
  				</td>
  				<td><input type="hidden" value="${orders[i].product_name}"></td>
  				<td><input type="hidden" value="${orders[i].production_area}"></td>
  				<td><input type="hidden" value="${orders[i].price}"></td>
  			</tr>`
   		}

   		contents += 
   		`	</tbody>
   		<table>`

   		document.getElementById("modal4Body").innerHTML = contents
  	}

  	const cartUpdateAndSetUpModal2 = () => {
  		let orders = []

  		const table = document.getElementById("modal4TBody")
  		for (let row of table.rows) {
  			let id = row.children[0].children[0].value
  		 	let oq = row.children[2].children[1].value
  		 	let name = row.children[3].children[0].value
  			let area = row.children[4].children[0].value
  			let price = row.children[5].children[0].value

  			let order = {
  				"id": id,
  				"product_name": name,
  				"production_area": area,
  				"price": price,
  				"order_quantity": oq
  			}
  			if (oq != 0) {
  				orders.push(order)
  			}
  		}
  		localStorage.setItem('order', JSON.stringify(orders))
  		setupModal2()
  	}

    window.addEventListener('DOMContentLoaded', (event) => {
    	localStorage.setItem('order', "[]")
    	const positionY = localStorage.getItem('positionY');
    	if (positionY !== null) {
        scrollTo(0, positionY);
        localStorage.removeItem('positionY');
    	}
		});
  </script>
</body>
</html>